# Payload decoders for Decentlab sensor devices

These samples are provided for integrating Decentlab sensor devices into your system.

Supported platforms are:

- C#
- Docksters
- ELEMENT-IoT Elixir
- Elixir
- Erlang
- JavaScript
- Lua
- PHP
- Python

Pull requests fixing issues, improving the quality or supporting new language/environments are welcome.

Please browse the devices in the corresponding directories:

Device | Name
---|---
[DL-10HS](DL-10HS) | [Legacy Large Soil Moisture Sensor for LoRaWAN&reg;](https://www.decentlab.com/support)
[DL-5TE](DL-5TE) | [Legacy Soil Moisture, Temperature and Electrical Conductivity Sensor for LoRaWAN&reg;](https://www.decentlab.com/support)
[DL-5TM](DL-5TM) | [Legacy Soil Moisture and Temperature Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/legacy-soil-moisture-and-temperature-sensor-for-lorawan)
[DL-AC](DL-AC) | [Air Quality Station NO₂, NO, CO, Oₓ for LoRaWAN&reg;](https://www.decentlab.com/products/air-quality-station-no2-no-co-ox-for-lorawan)
[DL-ATM22](DL-ATM22) | [Wind Speed, Wind Direction and Temperature Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/wind-speed-wind-direction-and-temperature-sensor-for-lorawan)
[DL-ATM41](DL-ATM41) | [Eleven Parameter Weather Station for LoRaWAN&reg;](https://www.decentlab.com/products/eleven-parameter-weather-station-for-lorawan)
[DL-CTD10](DL-CTD10) | [Pressure / Liquid Level, Temperature and Electrical Conductivity Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/pressure-/-liquid-level-temperature-and-electrical-conductivity-sensor-for-lorawan)
[DL-DLR2-002](DL-DLR2-002) | [Pulse Counter Dry Contact Transmitter for LoRaWAN&reg;](https://www.decentlab.com/products/analog-or-digital-sensor-device-for-lorawan)
[DL-DLR2-003](DL-DLR2-003) | [Digital Input Dry Contact Transmitter for LoRaWAN&reg;](https://www.decentlab.com/products/analog-or-digital-sensor-device-for-lorawan)
[DL-DLR2-004](DL-DLR2-004) | [Analog 4 … 20 mA Sensor Transmitter for LoRaWAN&reg;](https://www.decentlab.com/products/analog-or-digital-sensor-device-for-lorawan)
[DL-DLR2-005](DL-DLR2-005) | [Analog 0 … 3 V Sensor Transmitter for LoRaWAN&reg;](https://www.decentlab.com/products/analog-or-digital-sensor-device-for-lorawan)
[DL-DLR2-006](DL-DLR2-006) | [Analog Potentiometer Sensor Transmitter for LoRaWAN&reg;](https://www.decentlab.com/products/analog-or-digital-sensor-device-for-lorawan)
[DL-DLR2-008](DL-DLR2-008) | [Analog PT100 Sensor Transmitter for LoRaWAN&reg;](https://www.decentlab.com/products/analog-or-digital-sensor-device-for-lorawan)
[DL-DLR2-010](DL-DLR2-010) | [Dual Pulse Counter Dry Contact Transmitter for LoRaWAN&reg;](https://www.decentlab.com/products/analog-or-digital-sensor-device-for-lorawan)
[DL-DLR2-012](DL-DLR2-012) | [Analog Strain Gauge Sensor Transmitter for LoRaWAN&reg;](https://www.decentlab.com/products/analog-or-digital-sensor-device-for-lorawan)
[DL-DS18](DL-DS18) | [Temperature Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/temperature-sensor-for-lorawan)
[DL-GS3](DL-GS3) | [Legacy Ruggedized Soil Moisture, Temperature and Electrical Conductivity Sensor for LoRaWAN&reg;](https://www.decentlab.com/support)
[DL-IAM](DL-IAM) | [Indoor Ambiance Monitor including CO₂, TVOC and Motion Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/indoor-ambiance-monitor-including-co2-tvoc-and-motion-sensor-for-lorawan)
[DL-ITST](DL-ITST) | [Infrared Thermometer / Surface Temperature Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/infrared-thermometer-/-surface-temperature-sensor-for-lorawan)
[DL-KL66](DL-KL66) | [Strain / Weight Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/strain-/-weight-sensor-for-lorawan)
[DL-LP8P](DL-LP8P) | [CO₂, Temperature, Humidity and Barometric Pressure Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/co2-temperature-humidity-and-barometric-pressure-sensor-for-lorawan)
[DL-MBX](DL-MBX) | [Ultrasonic Distance / Level Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/ultrasonic-distance-/-level-sensor-for-lorawan)
[DL-PAR](DL-PAR) | [Photosynthetically Active Radiation Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/photosynthetically-active-radiation-sensor-for-lorawan)
[DL-PR21](DL-PR21) | [Pressure / Liquid Level and Temperature Sensor with G1/4" Pipe Thread for LoRaWAN&reg;](https://www.decentlab.com/products/pressure-/-liquid-level-and-temperature-sensor-with-g1/4-pipe-thread-for-lorawan)
[DL-PR26](DL-PR26) | [Pressure / Liquid Level and Temperature Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/pressure-/-liquid-level-and-temperature-sensor-for-lorawan)
[DL-PR36](DL-PR36) | [High-Precision Pressure / Liquid Level and Temperature Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/high-precision-pressure-/-liquid-level-and-temperature-sensor-for-lorawan)
[DL-PR36CTD](DL-PR36CTD) | [High-Precision Pressure / Liquid Level, Temperature and Electrical Conductivity Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/high-precision-pressure-/-liquid-level-temperature-and-electrical-conductivity-sensor-for-lorawan)
[DL-PYR](DL-PYR) | [Total Solar Radiation Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/total-solar-radiation-sensor-for-lorawan)
[DL-RHC](DL-RHC) | [High-Precision Air Temperature and Humidity Sensor with Radiation Shield for LoRaWAN&reg;](https://www.decentlab.com/products/high-precision-air-temperature-and-humidity-sensor-with-radiation-shield-for-lorawan)
[DL-SHT21](DL-SHT21) | [Air Temperature and Humidity Sensor with Radiation Shield for LoRaWAN&reg;](https://www.decentlab.com/support)
[DL-SHT35](DL-SHT35) | [Air Temperature and Humidity Sensor with Radiation Shield for LoRaWAN&reg;](https://www.decentlab.com/products/air-temperature-and-humidity-sensor-with-radiation-shield-for-lorawan)
[DL-SMTP](DL-SMTP) | [Soil Moisture and Temperature Profile for LoRaWAN&reg;](https://www.decentlab.com/products/soil-moisture-and-temperature-profile-for-lorawan)
[DL-TBRG](DL-TBRG) | [Tipping Bucket Rain Gauge for LoRaWAN&reg;](https://www.decentlab.com/products/tipping-bucket-rain-gauge-for-lorawan)
[DL-TRS11](DL-TRS11) | [Soil Moisture, Temperature and Electrical Conductivity Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/soil-moisture-temperature-and-electrical-conductivity-sensor-for-lorawan)
[DL-TRS12](DL-TRS12) | [Soil Moisture, Temperature and Electrical Conductivity Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/soil-moisture-temperature-and-electrical-conductivity-sensor-for-lorawan)
[DL-TRS21](DL-TRS21) | [Soil Water Potential and Temperature Sensor for LoRaWAN&reg;](https://www.decentlab.com/products/soil-water-potential-and-temperature-sensor-for-lorawan)
[DL-WRM](DL-WRM) | [Winter Road Maintenance Sensor for LoRaWAN&reg;](https://www.decentlab.com/support)
[DL-ZN1](DL-ZN1) | [Dendrometer for LoRaWAN&reg;](https://www.decentlab.com/products/dendrometer-for-lorawan)
[DL-ZN2](DL-ZN2) | [Dual Dendrometer for LoRaWAN&reg;](https://www.decentlab.com/products/dendrometer-for-lorawan)

# Testing payload

If you need to test a particular payload received from Decentlab devices, please follow this link: https://htmlpreview.github.io/?https://github.com/decentlab/decentlab-decoders/blob/master/payload-test.html

# Encoding downlink commands

If you need to encode downlink commands to be sent to Decentlab devices, please follow this link: https://htmlpreview.github.io/?https://github.com/decentlab/decentlab-decoders/blob/master/downlink-command-encoder.html

# Integration guide for some platforms

## The Things Network

Go to your application on *TTN Console* and select `Payload Formats`. Take the *JavaScript* implementation and paste into the `decoder` window by overwriting its content. Remove the `main()` function and its call.
```js
function main() {
    ...
}

main();
```

Append the following lines.
```js
function Decoder(bytes, port) {
  return decentlab_decoder.decode(bytes);
}
```

Copy example payload message from the datasheet, paste into `Payload`, and click `Test`. Make sure the output values match against the datasheet example and  save the decoder.

The decoders may output nested objects, which are stored as text in the TTN Data Storage integration.

:warning: The decoders may output a field named `device_id`, which may prohobit per-device querying in the TTN Data Storage integration.

## ELEMENT IoT

Go to `Automation`, `Parser`, and create a new parser. Take *ELEMENT-IoT Elixir* implementation and paste into the `Code` window by overwriting its content. Test the provided payloads against the datasheet and save.

## ResIOT

Go to `Nodes/Devices` and select the target device. Select `Manual Lua Scene` from the `Payload parsing scene mode` list.

Take the *Lua* implementation and paste into the `Lua Code` editor. Remove the `main()` function and its call.
```lua
local function main()
  ...
end

main()
```

Append the following lines.
```lua
-- get payload
if resiot_startfrom() == "Manual" then
    payload_hex = payloads[1]
    port = "99"
    deveui = ""
    appeui = ""
else
    payload_hex = resiot_comm_getparam("payload")
    port = resiot_comm_getparam("port")
    deveui = resiot_payload_getparam("deveui")
    appeui = resiot_payload_getparam("appeui")
end

-- decode
local decoded = decentlab_decode(payload_hex)

-- set decoded fields
for k, v in pairs(decoded) do
  if type(v) == "table" then
    if resiot_startfrom() == "Manual" then
      resiot_debug(k .. ": " .. v["value"] .. " " .. (v["unit"] or ""))
    else
      resiot_setnodevalue(appeui, deveui, k, v["value"])
    end
  else
    if resiot_startfrom() == "Manual" then
      resiot_debug(k .. ": " .. v)
    else
      resiot_setnodevalue(appeui, deveui, k, v)
    end
  end
end
```

Test the decoder by clicking `Run` and make sure the output values match against the datasheet. Configure the fields in `Node fields` for each sensor name and press `Save` icon.

## Docksters

In the Docksters app portal, go to `Developer`, `Device Definitions`, and `Your Definitions`. The JSON-encoded device definitions can be directly uploaded with `Upload Device Definition` button. However, depending on the use case, you may want to use the following `pre-parser` to normalize the data format for the device definitions. This pre-parser also determines the device ID from the payload.

```js
function parseProvider(payload, time, encoding) {
    var data = {};
    var buf = Buffer.from(payload, encoding);

    if (buf[0] !== 2) {
        return null;
    }

    data.deviceName = 'DL-' + String((buf[1] << 8) + buf[2]).padStart(5, '0');
    data.payload = buf.toString("hex");
    data.time = time;

    return data;
}

function parseTTN(obj) {
    return parseProvider(obj.payload_raw, obj.metadata.time, "base64");
}

function parseChirpstack(obj) {
    return parseProvider(obj.data, obj.time, "base64");
}

function parseActility(obj) {
    return parseProvider(obj.DevEUI_uplink.payload_hex, obj.DevEUI_uplink.Time, "hex");
}

function preParse(payloadStr)
{
    // use payloadStr to look up the device name and some other values
    try
    {
        var obj = JSON.parse(payloadStr);

        if ('applicationID' in obj) {
            return parseChirpstack(obj);
        }

        if ('app_id' in obj) {
            return parseTTN(obj);
        }

        if ('DevEUI_uplink' in obj) {
            return parseActility(obj)
        }

    }
    catch (err) {}  //some description of err would be nice

    return null;
}
```

Once you have a device sending data to `Docksters`, you will see it in `Devices` and `Pending Devices`. Select the matching definition from the list and add it.
